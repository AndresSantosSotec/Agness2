import{r as h,s as $,w as z}from"./chunk-NL6KNZEE-igR-ERF4.js";import{j as a}from"./jsx-runtime-D_zvdyIk.js";import{L as U,y as o,P as D}from"./PrivateRoute-qKyg2_uq.js";import{i as O,j as y,k as G,l as H,m as I}from"./index-9DermFXF.js";import{u as T}from"./authStore-Du5Ti9MW.js";import{a as p}from"./client-DVUqMjJO.js";import{a as J}from"./ably-YpHEacPo.js";const K=()=>{const[w,b]=h.useState(!0),[g,v]=h.useState({usuario:"",terminal:"",tipo:""}),[n,u]=h.useState(null),[N,E]=h.useState({totalTurnos:0,completados:0,enEspera:0,enProceso:0,cancelados:0,tiempoPromedio:"5min"}),[x,d]=h.useState({llamarSiguiente:!0,llamarNuevamente:!0,completarTurno:!0,saltarTurno:!0,cancelarTurno:!0}),[M,C]=h.useState(null),k=$(),t=T(e=>e.user),S=T(e=>e.token);h.useEffect(()=>{(async()=>{var r,l;b(!0);try{if(!t||!S)throw new Error("No hay sesión activa");const i=t.user||t;if(!((r=i.terminal)!=null&&r.id)){o.error("Usuario sin terminal asignada"),v({usuario:i.name,terminal:"No tiene terminal asignada",tipo:"No disponible"});return}const f=J.channels.get("turnos");C(f),f.subscribe("nuevo-llamado",j=>{var s;const c=(t==null?void 0:t.user)||t;(s=c==null?void 0:c.terminal)!=null&&s.id&&(m(c.terminal.tipo.id),console.log("Nuevo turno recibido:",j.data))}),f.subscribe("turno-actualizado",j=>{var s;const c=(t==null?void 0:t.user)||t;(s=c==null?void 0:c.terminal)!=null&&s.id&&(console.log("Turno actualizado recibido:",j.data),m(c.terminal.tipo.id))}),v({usuario:i.name,terminal:i.terminal.nombre,tipo:((l=i.terminal.tipo)==null?void 0:l.nombre)||"No disponible"}),await m(i.terminal.tipo.id),await L(i.id)}catch(i){console.error("Error:",i),T.getState().logout()}finally{b(!1)}})()},[t,S]);const P=()=>{T.getState().logout(),k("/")},m=async e=>{try{const r=await p.get(`/api/turnos/listar-turnos/${e}`),l=r.data.length,i=r.data.filter(s=>s.estado==="atendido").length,f=r.data.filter(s=>s.estado==="pendiente").length,j=r.data.filter(s=>s.estado==="llamado").length,c=r.data.filter(s=>s.estado==="cancelado").length;A(r.data.filter(s=>s.estado==="pendiente"||s.estado==="llamado")),E({totalTurnos:l,completados:i,enEspera:f,enProceso:j,cancelados:c,tiempoPromedio:"5min"})}catch(r){console.error("Error al obtener turnos:",r)}},L=async e=>{try{const r=await p.get(`/api/turnos/actual-user/${e}`);r.data.hasCurrentTurn?(u(r.data.turno),d({llamarSiguiente:!0,llamarNuevamente:!1,completarTurno:!1,saltarTurno:!1,cancelarTurno:!1})):(u(null),d({llamarSiguiente:!1,llamarNuevamente:!0,completarTurno:!0,saltarTurno:!0,cancelarTurno:!0}))}catch(r){console.error("Error al obtener turnos:",r)}},[_,A]=h.useState([]),q=async e=>{try{const r=await p.post("/api/turnos/llamar",{terminal_id:e});if(r.data.success)return r.data.hasPendingTurn?(u(r.data.turno),d({llamarSiguiente:!0,llamarNuevamente:!1,completarTurno:!1,saltarTurno:!1,cancelarTurno:!1}),await m(e),r.data.turno):(u(null),d({llamarSiguiente:!1,llamarNuevamente:!0,completarTurno:!0,saltarTurno:!0,cancelarTurno:!0}),await m(e),o.info("No hay turnos pendientes para llamar"),null)}catch(r){throw o.error("Error al llamar turnos"),r}},F=async()=>{var e;if(!n){o.info("No hay turno actual para completar");return}try{if((await p.post("/api/turnos/completar",{turno_id:n.id})).data.success){u(null),d({llamarSiguiente:!1,llamarNuevamente:!0,completarTurno:!0,saltarTurno:!0,cancelarTurno:!0});const l=(t==null?void 0:t.user)||t;(e=l==null?void 0:l.terminal)!=null&&e.id&&await m(l.terminal.tipo.id)}}catch(r){console.error("Error al completar el turno:",r),o.error("Error al completar el turno")}},R=async()=>{if(!n){o.info("No hay turno actual para saltar");return}try{const e=await p.post("/api/turnos/saltar",{turno_id:n.id});if(e.data.success)return e.data.hasNextTurn?(u(e.data.turno),d({llamarSiguiente:!0,llamarNuevamente:!1,completarTurno:!1,saltarTurno:!1,cancelarTurno:!1}),await m(n.tipo_terminal_id),e.data.turno):(u(null),d({llamarSiguiente:!1,llamarNuevamente:!0,completarTurno:!0,saltarTurno:!0,cancelarTurno:!0}),o.info("No hay turnos pendientes para llamar"),null)}catch{o.error("Error al completar el turno")}},B=async()=>{if(!n){o.info("No hay turno actual para llamar nuevamente");return}try{const e=await p.post("/api/turnos/recall",{turno_id:n==null?void 0:n.id});if(e.data.success)if(e.data.hasCurrentTurn)u(e.data.turno);else return u(null),o.info("No hay turno actual para llamar nuevamente"),d({llamarSiguiente:!1,llamarNuevamente:!0,completarTurno:!0,saltarTurno:!0,cancelarTurno:!0}),null}catch(e){throw console.error("Error al llamar turnos:",e),e}},V=async()=>{var e;if(!n){o.info("No hay turno actual para cancelar"),d({llamarSiguiente:!1,llamarNuevamente:!0,completarTurno:!0,saltarTurno:!0,cancelarTurno:!0});return}try{const r=await p.post("/api/turnos/cancelar",{turno_id:n.id});if(r.data.success){o.info("Turno cancelado"),u(null),d({llamarSiguiente:!1,llamarNuevamente:!0,completarTurno:!0,saltarTurno:!0,cancelarTurno:!0});const l=(t==null?void 0:t.user)||t;(e=l==null?void 0:l.terminal)!=null&&e.id&&await m(l.terminal.id)}else console.error("Error al cancelar el turno:",r.data.message),o.error("Error al cancelar el turno ")}catch(r){console.error("Error al cancelar el turno:",r)}};return a.jsxs("div",{className:"ventanilla-container",children:[a.jsx("header",{className:"ventanilla-header",children:a.jsxs("div",{className:"header-info",children:[a.jsxs("div",{className:"header-left",children:[a.jsx("h1",{className:"panel-title",children:"Panel de Ventanilla"}),a.jsxs("div",{className:"user-terminal-info",children:[a.jsxs("span",{className:"info-item",children:[a.jsx("strong",{children:"Usuario:"})," ",g.usuario||"No disponible"]}),a.jsxs("span",{className:"info-item",children:[a.jsx("strong",{children:"Terminal:"})," ",g.terminal||"No disponible"]}),a.jsxs("span",{className:"info-item",children:[a.jsx("strong",{children:"Servicio:"})," ",g.tipo||"No disponible"]})]})]}),a.jsxs("div",{className:"header-right",children:[a.jsx("div",{className:"current-date",children:new Date().toLocaleDateString("es-ES",{weekday:"long",year:"numeric",month:"long",day:"numeric"})}),a.jsxs("button",{className:"logout-btn",onClick:P,title:"Cerrar Sesión",children:[a.jsx(O,{})," Cerrar Sesión"]})]})]})}),a.jsxs("div",{className:"main-panel",children:[a.jsxs("div",{className:"action-buttons",children:[a.jsxs("button",{disabled:x.llamarSiguiente,className:"action-btn call-btn",onClick:()=>{var r;const e=(t==null?void 0:t.user)||t;(r=e==null?void 0:e.terminal)!=null&&r.id&&q(e.terminal.tipo.id)},children:[a.jsx(y,{})," Llamar Siguiente"]}),a.jsxs("button",{disabled:x.llamarNuevamente,className:"action-btn recall-btn",onClick:()=>{var r;const e=(t==null?void 0:t.user)||t;(r=e==null?void 0:e.terminal)!=null&&r.id&&B()},children:[a.jsx(y,{})," Llamar Nuevamente"]}),a.jsxs("button",{disabled:x.completarTurno,className:"action-btn complete-btn",onClick:F,children:[a.jsx(G,{})," Completar Turno"]}),a.jsxs("button",{disabled:x.saltarTurno,className:"action-btn skip-btn",onClick:R,children:[a.jsx(H,{})," Saltar Turno"]}),a.jsxs("button",{disabled:x.cancelarTurno,className:"action-btn cancelar-btn",onClick:V,children:[a.jsx(I,{})," Cancelar Turno"]})]}),a.jsxs("div",{className:"content-grid",children:[a.jsxs("div",{className:"left-column",children:[a.jsxs("div",{className:"section",children:[a.jsx("h2",{className:"section-title",children:"Turno Actual"}),a.jsx("div",{className:"current-turn",children:n?a.jsxs(a.Fragment,{children:[a.jsx("span",{className:"turn-code",children:n.codigo}),a.jsx("span",{className:"turn-status",children:n.estado}),a.jsx("span",{className:"turn-time",children:new Date(n.fecha_creacion).toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit"})})]}):a.jsx("span",{className:"no-turn",children:"Sin turno actual"})})]}),a.jsxs("div",{className:"section",children:[a.jsx("h2",{className:"section-title",children:"Próximos Turnos"}),a.jsx("div",{className:"queue-list",children:_.map(e=>a.jsxs("div",{className:"queue-item",children:[a.jsx("div",{className:`queue-marker ${e.codigo.charAt(0).toLowerCase()}-type`}),a.jsxs("div",{className:"queue-details",children:[a.jsx("span",{className:"queue-id",children:e.codigo}),a.jsx("span",{className:"queue-time",children:new Date(e.fecha_creacion).toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit",second:"2-digit"})})]}),a.jsx("span",{className:"queue-status",children:e.estado})]},e.id))})]})]}),a.jsx("div",{className:"right-column",children:a.jsxs("div",{className:"section",children:[a.jsx("h2",{className:"section-title",children:"Estadísticas del Día"}),a.jsxs("div",{className:"stats-grid",children:[a.jsxs("div",{className:"stat-box",children:[a.jsx("span",{className:"stat-number blue",children:N.totalTurnos}),a.jsx("span",{className:"stat-label",children:"Total Turnos"})]}),a.jsxs("div",{className:"stat-box",children:[a.jsx("span",{className:"stat-number green",children:N.completados}),a.jsx("span",{className:"stat-label",children:"Completados"})]}),a.jsxs("div",{className:"stat-box",children:[a.jsx("span",{className:"stat-number orange",children:N.enProceso}),a.jsx("span",{className:"stat-label",children:"En proceso"})]}),a.jsxs("div",{className:"stat-box",children:[a.jsx("span",{className:"stat-number red",children:N.enEspera}),a.jsx("span",{className:"stat-label",children:"Pendientes"})]}),a.jsxs("div",{className:"stat-box",children:[a.jsx("span",{className:"stat-number red",children:N.cancelados}),a.jsx("span",{className:"stat-label",children:"Cancelados"})]})]})]})})]})]}),a.jsx(U,{"aria-label":void 0})]})},ra=z(function(){return a.jsx(D,{allowedRoles:[1,2,3,4,5,6,7,8],children:a.jsx(K,{})})});export{ra as default};
